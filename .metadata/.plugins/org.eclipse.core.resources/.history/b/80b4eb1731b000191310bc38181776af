package ec.edu.uce.Biometrico.ejb.servicios.impl;

import java.util.ArrayList;
import java.util.List;

import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;

import ec.edu.uce.Biometrico.ejb.servicios.interfaces.SrvHorarioLocal;
import ec.uce.edu.biometrico.jpa.Asistencia;
import ec.uce.edu.biometrico.jpa.Aula;
import ec.uce.edu.biometrico.jpa.Carrera;
import ec.uce.edu.biometrico.jpa.DiaSemana;
import ec.uce.edu.biometrico.jpa.FichaDocente;
import ec.uce.edu.biometrico.jpa.HorarioAcademico;
import ec.uce.edu.biometrico.jpa.HorarioAcademicoExamen;
import ec.uce.edu.biometrico.jpa.Materia;
import ec.uce.edu.biometrico.jpa.Paralelo;
import ec.uce.edu.biometrico.jpa.Nivel;
import ec.uce.edu.biometrico.jpa.TipoHorario;
import sun.util.locale.provider.AuxLocaleProviderAdapter;

/**
 * Session Bean implementation class SrvHorario
 */
@Stateless
@LocalBean
public class SrvHorario implements SrvHorarioLocal {

	@PersistenceContext
	EntityManager em;

	/**
	 * Default constructor.
	 */
	public SrvHorario() {
	}

	@Override
	public List<Carrera> listarAllCrr(Integer fcId) {
		List<Carrera> lstC = new ArrayList<>();
		try {
			Object[] arrayObj;
			Query query = em
					.createQuery(
							"select cr.crrId from DetallePuesto as dp join dp.carrera as cr where dp.fichaDocente.fcdcId=:fcId group by cr.crrId")
					.setParameter("fcId", fcId);
			for (Object obj : query.getResultList()) {
				arrayObj = (Object[]) obj;
				lstC.add(em.find(Carrera.class, arrayObj[0]));
			}
		} catch (Exception e) {
			System.out.println("Error al obtener Carreras por Docente");
		}
		return lstC;
	}

	@Override
	public List<Materia> listarAllMat() {
		List<Materia> lstM = em.createNamedQuery("Materia.findAll", Materia.class).getResultList();
		return lstM;
	}

	@Override
	public List<Nivel> listarSemestrexCarrera(Integer fdId, Integer crrId) {
		List<Nivel> lstN = new ArrayList<>();
		try {
			Query query = em.createQuery(
					"select nv.nvlId from HorarioAcademico as ha join ha.mallaCurricularParalelo as mcpr join mcpr.paralelo as p join mcpr.mallaCurricularMateria as mcm join mcm.materia as ma join ma.carrera as cr join mcm.nivelByNvlId as nv  join ha.horaClaseAula as hca join hca.horaClase as hc join hca.aula as al  where mcpr.mlcrprId in ( select mcp.mlcrprId from CargaHoraria as ch inner join ch.mallaCurricularParalelo as mcp join ch.periodoAcademico as pa  where pa.pracEstado=0 and ch.detallePuesto.fichaDocente.fcdcId=:fdId group by mcp.mlcrprId) and hca.hoclalEstado=0 and cr.crrId=:crId group by nv.nvlId order by nv.nvlId asc");
			query.setParameter("crId", crrId).setParameter("fdId", fdId);
			for (Object obj : query.getResultList()) {
				lstN.add(em.find(Nivel.class, obj));
			}
		} catch (Exception e) {
			System.out.println("Error al consultar semestres x carrera");
			return lstN;
		}
		return lstN;
	}

	@Override
	public List<Materia> listarMatByCrr(Integer id) {
		List<Materia> lstM = em.createNamedQuery("Materia.findAllById", Materia.class).setParameter("idcr", id)
				.getResultList();
		return lstM;
	}

	@Override
	public List<Materia> listarMatBySem(Integer fdId, Integer idSemestre, Integer idCarrera) {
		List<Materia> lstM = new ArrayList<>();
		try {
			Query query = em.createQuery(
					"select ma.mtrId from HorarioAcademico as ha join ha.mallaCurricularParalelo as mcpr join mcpr.paralelo as p join mcpr.mallaCurricularMateria as mcm join mcm.materia as ma join ma.carrera as cr join mcm.nivelByNvlId as nv  join ha.horaClaseAula as hca join hca.horaClase as hc join hca.aula as al  where mcpr.mlcrprId in ( select mcp.mlcrprId from CargaHoraria as ch inner join ch.mallaCurricularParalelo as mcp join ch.periodoAcademico as pa  where pa.pracEstado=0 and ch.detallePuesto.fichaDocente.fcdcId=:fdId group by mcp.mlcrprId) and hca.hoclalEstado=0 and cr.crrId=:crrId and nv.nvlId=:smsId group by ma.mtrId order by ma.mtrId asc");
			query.setParameter("smsId", idSemestre);
			query.setParameter("crrId", idCarrera);
			query.setParameter("fdId", fdId);
			for (Object obj : query.getResultList()) {
				lstM.add(em.find(Materia.class, obj));
			}
		} catch (Exception e) {
			System.out.println("Error al consultar materias por semestre: " + e);
			return lstM;
		}
		return lstM;
	}

	@Override
	public List<Paralelo> listarParalelosHorario(Integer fdId, Integer idSemestre, Integer idMateria,
			Integer idCarrera) {
		List<Paralelo> lstPar = new ArrayList<>();
		try {
			Query query = em.createQuery(
					"select p.prlId from HorarioAcademico as ha join ha.mallaCurricularParalelo as mcpr join mcpr.paralelo as p join mcpr.mallaCurricularMateria as mcm join mcm.materia as ma join ma.carrera as cr join mcm.nivelByNvlId as nv  join ha.horaClaseAula as hca join hca.horaClase as hc join hca.aula as al  where mcpr.mlcrprId in ( select mcp.mlcrprId from CargaHoraria as ch inner join ch.mallaCurricularParalelo as mcp join ch.periodoAcademico as pa  where pa.pracEstado=0 and ch.detallePuesto.fichaDocente.fcdcId=:fdId group by mcp.mlcrprId) and hca.hoclalEstado=0 and cr.crrId=:crrId and nv.nvlId=:smsId and ma.mtrId=:mtrId group by p.prlId order by p.prlId asc");
			query.setParameter("smsId", idSemestre);
			query.setParameter("crrId", idCarrera);
			query.setParameter("mtrId", idMateria);
			query.setParameter("fdId", fdId);
			for (Object obj : query.getResultList()) {
				lstPar.add(em.find(Paralelo.class, obj));
			}
		} catch (Exception e) {
			System.out.println("Error al consultar paralelos por semestre, materia y carrera: " + e);
		}
		return lstPar;
	}

	@Override
	public List<Aula> listarAula() {
		List<Aula> lstAula = null;
		try {
			Query query = em.createQuery("select aula from Aula as aula");
			lstAula = query.getResultList();
		} catch (Exception e) {
			System.out.println("Error al consultar los aulas" + e);
		}
		return lstAula;
	}

	@Override
	public void guardarHorario(HorarioAcademico horario) {
		try {
			if (horario.getHracId() != null) {
				em.merge(horario);
			} else {
				int h = obtenerSecuenciaHorario();
				horario.setHracId(h + 1);
				em.persist(horario);
			}
		} catch (Exception e) {
			System.out.println("Error al guardar horario" + e);
		}
	}

	private int obtenerSecuenciaHorario() {
		int h = 0;
		try {
			Query query = em.createQuery("select h.hracId from HorarioAcademico as h  order by h.hracId desc");
			query.setMaxResults(1);
			h = (int) query.getSingleResult();
		} catch (Exception e) {
			System.out.println("Error al consultar los horarios secuencia" + e);
			return h;
		}
		return h;
	}

	@Override
	public List<HorarioAcademico> listarHorarios(Integer fdId, Integer idParalelo, Integer idMateria) {
		List<HorarioAcademico> lstHorario = new ArrayList<>();
		try {
			Query query = em.createQuery(
					"select ha.hracId from HorarioAcademico as ha join ha.mallaCurricularParalelo as mcpr join mcpr.paralelo as p join mcpr.mallaCurricularMateria as mcm join mcm.materia as ma join ma.carrera as cr join mcm.nivelByNvlId as nv  join ha.horaClaseAula as hca join hca.horaClase as hc join hca.aula as al  where mcpr.mlcrprId in ( select mcp.mlcrprId from CargaHoraria as ch inner join ch.mallaCurricularParalelo as mcp join ch.periodoAcademico as pa  where pa.pracEstado=0 and ch.detallePuesto.fichaDocente.fcdcId=:fdId group by mcp.mlcrprId) and hca.hoclalEstado=0 and ma.mtrId=:mtrId and p.prlId=:prlId group by ha.hracId order by ha.hracId asc");
			query.setParameter("prlId", idParalelo);
			query.setParameter("mtrId", idMateria);
			query.setParameter("fdId", fdId);
			System.out.println("Valores de la lista");
			for (Object obj : query.getResultList()) {
				lstHorario.add(em.find(HorarioAcademico.class, obj));
			}
			// List<HorarioAcademico> lstAux = lstHorario;
			// for (HorarioAcademico h : lstHorario) {
			// List<HorarioAcademico> auxHorario = new ArrayList<>();
			// for (HorarioAcademico h2 : lstAux) {
			// if (h.getHracDia().equals(h2.getHracDia()) &&
			// h.getMallaCurricularParalelo().getMlcrprId()
			// .equals(h2.getMallaCurricularParalelo().getMlcrprId())) {
			// auxHorario.add(h2);
			// }
			// }
			// for (int i = 1; i<auxHorario.size(); i++) {
			// lstAux.remove(auxHorario.get(i));
			// }
			// }
			// lstHorario = lstAux;
		} catch (Exception e) {
			System.out.println("Error al consultar los horarios" + e);
			return lstHorario;
		}
		return lstHorario;
	}

	/*
	 * @Override public List<Horario> listarHorarios(String prcdId) {
	 * List<Horario> lstH = new ArrayList<>(); try { // lstH =
	 * em.createNamedQuery("Horario.findAllByPrlId", //
	 * Horario.class).setParameter("prlId", prcdId).getResultList(); Query query
	 * = em.
	 * createQuery("select  h,th,m,fd,a,ds from Horario as h join h.tipoHorario as th "
	 * +
	 * " join h.materia as m join h.fichaDocente as fd join h.aula as a join h.diaSemana as ds "
	 * +
	 * "where m.mtrId in(select mcp.mallaCurricularMateria.materia.mtrId from MallaCurricularParalelo as mcp where mcp.paralelo.prlCodigo=:prlCd) "
	 * + "order by ds,h asc"); query.setParameter("prlCd", prcdId);
	 * System.out.println("Valores de la lista"); for (Object obj :
	 * query.getResultList()) { Object[] objArray = (Object[]) obj;
	 * lstH.add((Horario) objArray[0]); } } catch (Exception e) {
	 * System.out.println("No se enontranos horarios " + e); return lstH; }
	 * return lstH; }
	 */

	@Override
	public void eliminarHorario(HorarioAcademico horario) {
		try {
			HorarioAcademico h = em.find(HorarioAcademico.class, horario.getHracId());
			if (h != null) {
				em.remove(h);
			}
		} catch (Exception e) {
			System.out.println("Error al eliminar horario" + e);
		}
	}

	@Override
	public void actualizarGuardarAsistencia(Asistencia asis) {
		try {
			if (asis.getAssId() != null) {
				System.out.println(asis.getAssFecha());
				em.merge(asis);
			} else {
				System.out.println(asis.getAssFecha());
				asis.setAssId(obtenerSecAsistencia() + 1);
				em.persist(asis);
			}
		} catch (Exception e) {
			System.out.println("No se puede guardar asistencia");
		}
		
	}

}
