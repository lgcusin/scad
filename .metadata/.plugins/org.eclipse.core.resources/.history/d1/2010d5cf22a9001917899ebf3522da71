package ec.edu.uce.Biometrico.ejb.servicios.impl;

import java.util.ArrayList;
import java.util.List;

import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;

import ec.edu.uce.Biometrico.ejb.servicios.interfaces.SrvEmpleadoLocal;
import ec.uce.edu.biometrico.jpa.Carrera;
import ec.uce.edu.biometrico.jpa.FichaDocente;
import ec.uce.edu.biometrico.jpa.HorarioAcademico;
import ec.uce.edu.biometrico.jpa.Persona;
import ec.uce.edu.biometrico.jpa.UnidadCurricular;

/**
 * Session Bean implementation class SrvEmpleado
 */
@Stateless
@LocalBean
public class SrvEmpleado implements SrvEmpleadoLocal {

	@PersistenceContext
	EntityManager em;

	/**
	 * Default constructor.
	 */
	public SrvEmpleado() {
		// TODO Auto-generated constructor stub
	}

	@Override
	public List<Carrera> listarCarreras(Integer fcId) {
		List<Carrera> lstC = new ArrayList<>();
		try {
			Query query = em.createQuery("select c from Carrera as c where c.dependencia.dpnId=:fcId")
					.setParameter("fcId", fcId);
			lstC = query.getResultList();
		} catch (Exception e) {
			System.out.println(e);
			return lstC;
		}

		return lstC;
	}

	@Override
	public List<FichaDocente> listarDocentes(Integer crrId) {
		List<FichaDocente> lstD = new ArrayList<>();
		try {
			Object[] arraObj;
			Query query = em
					.createQuery(
							"select fd,dp,p from DetallePuesto as dp join dp.fichaDocente as fd join fd.persona as p where dp.carrera.crrId=:crId order by p desc")
					.setParameter("crId", crrId);
			for (Object obj : query.getResultList()) {
				arraObj = (Object[]) obj;
				lstD.add((FichaDocente) arraObj[0]);
			}
		} catch (Exception e) {
			System.out.println(e);
			return lstD;
		}
		return lstD;
	}

	@Override
	public List<HorarioAcademico> listarHorariosxDocentexFechaHora(Integer integer, Integer[] arrayHora,int dia) {
		List<HorarioAcademico> lstH = new ArrayList<>();
		try {
			Object[] arrayObj;
			Query query = em.createQuery(
					"select ha.hracId,cr.crrId,nv.nvlId, p.prlId, ma.mtrId,ha.hracDia,hc.hoclId, al.alaId from HorarioAcademico as ha join ha.mallaCurricularParalelo as mcp join mcp.paralelo as p join mcp.mallaCurricularMateria as mcm join mcm.materia as ma join ma.carrera as cr join mcm.nivelByNvlId as nv  join ha.horaClaseAula as hca join hca.horaClase as hc join hca.aula as al where mcp.mlcrprId in ( select mcp.mlcrprId from CargaHoraria as ch inner join ch.mallaCurricularParalelo as mcp join ch.periodoAcademico as pa  where pa.pracEstado=0 and ch.detallePuesto.fichaDocente.fcdcId=:fdId group by mcp.mlcrprId) and hca.hoclalEstado=0 and ha.hracDia=:dia and hc.hoclHoraFin between :Hinicio and :Hfin order by cr.crrId,nv.nvlId, p.prlId, ha.hracDia");
			query.setParameter("fdId", integer).setParameter("dia", dia).setParameter("Hinicio", arrayHora[0]).setParameter("Hfin",
					arrayHora[2]);
			for (Object obj : query.getResultList()) {
				arrayObj = (Object[]) obj;
				lstH.add((HorarioAcademico) arrayObj[0]);
			}
		} catch (Exception e) {
			System.out.println("Error al listar horarios del Docente por dia -hora");
			return lstH;
		}
		return lstH;
	}

	@Override
	public List<FichaDocente> listarDocentesxCarrera(Integer crrId) {
		List<FichaDocente> lstD = new ArrayList<>();
		try {
			Query query;
			Object[] objArray;
			query = em.createQuery(
					"select fd.fcdcId,p.prsId,p.prsPrimerApellido,p.prsSegundoApellido,p.prsNombres from DetallePuesto as dp join dp.fichaDocente as fd join fd.persona as p join dp.carrera as c  where c.crrId=:crrId group by fd.fcdcId,p.prsId,p.prsPrimerApellido,p.prsSegundoApellido,p.prsNombres order by p.prsPrimerApellido, p.prsSegundoApellido");
			query.setParameter("crrId", crrId);
			for (Object obj : query.getResultList()) {
				objArray = (Object[]) obj;
				FichaDocente fd = new FichaDocente((Integer) objArray[0]);
				fd.setPersona(em.find(Persona.class, (Integer) objArray[1]));
				lstD.add(fd);
			}
		} catch (Exception e) {
			System.out.println("Error al consultar docentes por facultad");
			return lstD;
		}
		return lstD;
	}

}
