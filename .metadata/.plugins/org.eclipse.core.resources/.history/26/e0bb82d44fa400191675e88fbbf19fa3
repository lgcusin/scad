package ec.edu.uce.Biometrico.ejb.servicios.impl;

import java.util.ArrayList;
import java.util.List;

import javax.ejb.LocalBean;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.Query;

import ec.edu.uce.Biometrico.ejb.servicios.interfaces.SrvLoginLocal;
import ec.uce.edu.biometrico.jpa.DetallePuesto;
import ec.uce.edu.biometrico.jpa.Usuario;
import ec.uce.edu.biometrico.jpa.UsuarioRol;

/**
 * Session Bean implementation class LoginBean
 */
@Stateless
@LocalBean
public class SrvLogin implements SrvLoginLocal {

	@PersistenceContext
	EntityManager em;

	public SrvLogin() {
	}

	@Override
	public Usuario verificar(String nick, String clave) {
		Usuario usr = new Usuario();
		try {
			Object[] objArray;
			Query query;
			query = em.createQuery(
					"select usu, usr, p from UsuarioRol as usr join usr.usuario as usu join usu.persona as p where usu.usrNick=:nick and usu.usrPassword=:clave");
			query.setParameter("nick", nick).setParameter("clave", clave);
			Object obj = query.getSingleResult();
			objArray = (Object[]) obj;
			usr = (Usuario) objArray[0];
			usr.getUsuarioRols().add((UsuarioRol) objArray[1]);
		} catch (Exception e) {
			System.out.println("Error al obtener usuario" + e);
			return usr;
		}
		return usr;
	}

	@Override
	public List<DetallePuesto> buscarDetallePuesto(Integer fcdcId) {
		List<DetallePuesto> lstdp = new ArrayList<>();
		try {
			Object[] objArray;
			Query query;
			query = em.createQuery(
					"select dp,cr,fc from DetallePuesto as dp join dp.carrera as cr join cr.facultad as fc where dp.fichaDocente.fcdcId=:fdId");
			query.setParameter("fdId", fcdcId);
			for (Object object : query.getResultList()) {
				objArray = (Object[]) object;
				lstdp.add((DetallePuesto) objArray[0]);
			}
		} catch (Exception e) {
			System.out.println("Erroral obtener carrera/facultad del usuario");
			return lstdp;
		}
		return lstdp;
	}

}
